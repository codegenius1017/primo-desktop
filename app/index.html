<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset='utf-8'>
	<meta name='viewport' content='width=device-width,initial-scale=1'>

	<link rel='icon' type='image/png' href='./assets/favicon.png'>
	<link rel='stylesheet' href='./assets/primo.css'>
	<link rel='stylesheet' href='./assets/build/bundle.css'>

	<script>
		const PromiseWorker = require('promise-worker');
		function createWorker(dir) {
			const worker = new Worker(dir);
			return new PromiseWorker(worker);
		}

		const postcssWorker = createWorker('workers/postcss.js')
		const tailwindWorker = createWorker('workers/tailwind.js')
		async function processPostCSS(payload) {
			let response
			const { css, html, options, onsuccess } = payload
			if (options.includeTailwind) {
				response = await tailwindWorker.postMessage(payload)
			} else {
				response = await postcssWorker.postMessage(payload)
			}
			return response
		}

		const builderWorker = createWorker('workers/builder.js')
		async function buildSite(pages, site) {
			builderWorker.postMessage({ pages, site })
			return 
		}
		
		const defaultData = {
			"pages": [
				{
					"id": "index",
					"title": "primo Page",
					"content": [
						{
							"id": "0qodx",
							"width": "contained",
							"columns": [
								{
									"id": "00000",
									"size": "w-full",
									"rows": [
										{
											"id": "00000",
											"type": "content",
											"value": {
												"html": "<p>new stuff</p>"
											}
										}
									]
								}
							]
						}
					],
					"dependencies": {
						"headEmbed": "",
						"libraries": []
					},
					"styles": {
						"raw": "",
						"final": "",
						"tailwind": "{  theme: {    container: {      center: true    }  },  variants: {}}"
					},
					"wrapper": {
						"raw": {
							"head": "",
							"above": "",
							"below": ""
						},
						"final": {
							"head": "",
							"above": "",
							"below": ""
						}
					},
					"fields": [],
					"settings": {
						"javascript": "",
						"identity": {
							"title": "",
							"url": "",
							"description": ""
						}
					}
				}
			],
			"fields": [],
			"styles": {
				"raw": "/* Default content styles */\n.primo-content {\n  @apply text-lg;\n  h1 {\n    @apply text-3xl font-medium;\n  }\n  h2 {\n    @apply text-2xl font-medium;\n  }\n  ul {\n    @apply list-disc list-inside;\n    p {\n        @apply inline;\n    }\n  } \n  ol {\n    @apply list-decimal list-inside;\n  } \n  a {\n    @apply text-blue-600 underline;\n  }\n  blockquote {\n      @apply shadow-md p-6;\n  }\n  mark {\n    @apply text-gray-900 bg-yellow-200;\n  }\n  \n  @screen lg {\n    h1 {\n      @apply text-5xl;\n    }\n    h2 {\n      @apply text-4xl;\n    }\n  }\n}",
				"final": "",
				"tailwind": "{\n  theme: {\n    container: {\n      center: true\n    }\n  },\n  variants: {}\n}"
			},
			"wrapper": {
				"raw": {
					"head": "",
					"above": "",
					"below": ""
				},
				"final": {
					"head": "",
					"above": "",
					"below": ""
				}
			},
			"symbols": []
		}

    const low = require('lowdb')
    const FileSync = require('lowdb/adapters/FileSync')
    const fs = require('fs')
		const dataPath = nw.App.getDataPath()
		const buildDir = dataPath + `/db.json`
		const adapter = new FileSync(buildDir)
		const db = low(adapter)

		function parseDataFile(filePath) {
			let siteData = db.get('site').value()
			if (siteData) {
				return siteData
			} else {
				fs.writeFile(filePath, JSON.stringify({ site: defaultData }), (err) => {
					err && alert("An error ocurred creating the file "+ err.message)
				});
				return defaultData
			}
		}

		let siteData = parseDataFile(buildDir)

		async function updateDatabase(data) {
			db.set('site', data).write()
			siteData = data
		}


	</script>

	<script defer src='./assets/build/bundle.js'></script>
</head>

<style>
	#primo-toolbar {
		-webkit-app-region: drag;
	}
	.button-group, .button-container, .secondary-buttons, button {
		-webkit-app-region: no-drag;
	}
</style>

<body>
</body>
</html>

<script>
  const path = './';
  const fs = require('fs');
  
  const reloadWatcher = fs.watch(path, { recursive: true }, function() {
    location.reload();
    reloadWatcher.close();
  });

	for(var i in require.cache) {
		delete require.cache[i];
	}
</script>